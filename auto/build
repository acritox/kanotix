#!/bin/bash

. config/bootstrap
. config/common
. config/kanotix
bit=32
[ "$LB_ARCHITECTURE" = "amd64" ] && bit=64

# Update kanotix-version (32/64-bit and timestamp)
[ ! -f config/chroot_local-includes/etc/kanotix-version ] && echo "Kanotix Hellfire 0000-00:00" > config/chroot_local-includes/etc/kanotix-version
perl -pi -e "s%(Kanotix|Excalibur|Hellfire)(32|64)%\${1}$bit%i; s%(32|64)(bit)%$bit\${2}%i; s|[0-9]+-[0-9]+:[0-9]+|$(date +%Y%m%d-%H:%M)|" config/chroot_local-includes/etc/kanotix-version

prebuild()
{
	# Include nvidia-driver into chroot
	if [ "$LB_KANOTIX_NVIDIA" = "true" -a -f config/chroot_local-includes/usr/local/bin/install-nvidia-debian.sh ]; then
		mkdir -p config/chroot_local-includes/usr/src
		VER="$(grep -o ^VER=.* config/chroot_local-includes/usr/local/bin/install-nvidia-debian.sh|sed s/VER=//)"
		ARCH=; [ "$LB_ARCHITECTURE" = "amd64" ] && ARCH="_64"
		URL="http://download.nvidia.com/XFree86/Linux-x86$ARCH/$VER/NVIDIA-Linux-x86$ARCH-$VER.run"
		if [ "$LB_CACHE" = "false" ]; then
			wget -N -P config/chroot_local-includes/usr/src "$URL"
		else
			mkdir -p cache
			wget -N -P cache "$URL"
			cp "cache/$(basename "$URL")" "config/chroot_local-includes/usr/src/$(basename "$URL")"
		fi
	fi

	# make current build configuration available for hooks inside chroot
	mkdir -p config/chroot_local-includes/root
	cat config/* 2>/dev/null | grep ^LB_ > config/chroot_local-includes/root/build.conf

        # Kanotix flavours
        if [ "$LB_KANOTIX_FLAVOURS" -a "$LB_KANOTIX_FLAVOURS" != "none" ]; then
                echo "# DO NOT EDIT THIS FILE! It is auto-generated and will be deleted/ overwritten!" > config/chroot_local-packageslists/kanotix-flavours.list
                for FLAVOUR in $LB_KANOTIX_FLAVOURS
                do
                        echo "#include <$FLAVOUR>" >> config/chroot_local-packageslists/kanotix-flavours.list
                done
        fi
}

postbuild()
{
	rm -f config/chroot_local-includes/root/build.conf
        rm -f config/chroot_local-packageslists/kanotix-flavours.list
}

if [ "$LB_KANOTIX_TMPFS" = "true" ]; then
       mkdir -p tmpfs
       # build using tmpfs
       [ -z "$(stat --printf "%d\n" . tmpfs | uniq -u)" ] && mount -t tmpfs -o "$LB_KANOTIX_TMPFS_OPTIONS" tmpfs tmpfs
       cd tmpfs
       # delete everything except cache
       find . -maxdepth 1 ! -name cache -exec rm -r '{}' \; 2>/dev/null
       # copy everything to tmpfs
       rsync -a .. . --exclude=tmpfs
       # build
       prebuild
       time lb build noauto "${@}" 2>&1 | tee binary.log
       postbuild
       cd ..
else
       prebuild
       time lb build noauto "${@}" 2>&1 | tee binary.log
       postbuild
fi

exit 1
