#!/bin/bash

MIRROR_CHROOT=http://ftp.de.debian.org/debian
MIRROR_CHROOT_SECURITY=http://security.debian.org/
MIRROR_BINARY=http://ftp.de.debian.org/debian
MIRROR_BINARY_SECURITY=http://security.debian.org/
MIRROR_BOOTSTRAP="$MIRROR_CHROOT"

. auto/kanotix

# preset kanotix defaults
export LB_PACKAGES_LISTS="kanotix-master"
export LB_DISTRIBUTION="wheezy"
export LB_BOOTLOADER="grub2"
export LB_SYSLINUX_MENU_LIVE_ENTRY="Kanotix"
export LB_LINUX_PACKAGES="linux-image linux-headers"

lb config noauto \
	--iso-volume KANOTIX \
	--iso-preparer kanotix.com \
	--iso-publisher kanotix.com \
	--binary-images iso-hybrid \
	--chroot-filesystem squashfs \
	--debian-installer false \
	--apt apt \
	--apt-recommends false \
	--bootappend-live 'utc=no timezone=Europe/Berlin locales=de keyboard-layouts=de keyboard-variant=nodeadkeys splash' \
        --archive-areas "main contrib non-free" \
	--repositories "live.debian.net acritox hellfire lo" \
	--security true \
	--checksums md5 \
	--syslinux-timeout 5 \
	--syslinux-menu true \
	--syslinux-splash config/binary_syslinux/splash.png \
	--memtest memtest86+ \
	--mirror-bootstrap ${MIRROR_BOOTSTRAP} \
	--mirror-chroot ${MIRROR_CHROOT} \
	--mirror-chroot-security ${MIRROR_CHROOT_SECURITY} \
	--mirror-binary ${MIRROR_BINARY} \
	--mirror-binary-security ${MIRROR_BINARY_SECURITY} \
	--binary-indices true \
	"${@}" || exit $?

# hostname and username are configured in config/chroot_local-includes/etc/live/config.conf
#lb config noauto \
#	--hostname Kanotix \
#	--username kanotix \

# disable firmware packages (needed for newer lb versions)
lb config noauto \
	--firmware-binary false \
	--firmware-chroot false

. config/binary
. config/bootstrap
. config/chroot

# architecture and distribution depending stuff (e.g. kernel)
case "$LB_DISTRIBUTION" in
squeeze)
	LB_REPOSITORIES+=" firefox wine-ppa squeeze-backports"
	case $LB_ARCHITECTURE in
	amd64) LB_LINUX_PACKAGES="linux-image-3.2.0-17 linux-headers-3.2.0-17"; LB_LINUX_FLAVOURS="generic";;
	i386)  LB_LINUX_PACKAGES="linux-image-3.2.0-15 linux-headers-3.2.0-15"; LB_LINUX_FLAVOURS="generic";;
	esac
	;;
wheezy)
	LB_PACKAGES_LISTS+=" dragonfire"
	LB_REPOSITORIES+=" dragonfire wine-ppa-oneiric"
	case $LB_ARCHITECTURE in
	amd64) LB_LINUX_PACKAGES="linux-image linux-headers"; LB_LINUX_FLAVOURS="amd64";;
	i386)  LB_LINUX_PACKAGES="linux-image linux-headers"; LB_LINUX_FLAVOURS="686-pae";;
	esac
	;;
esac

[ "$LB_BOOTLOADER" = "burg" ] && LB_REPOSITORIES+=" burg"
grep -wq kde48 <<<"$LB_PACKAGES_LISTS" && LB_REPOSITORIES+=" acritox-kde48"
grep -wq trinity <<<"$LB_PACKAGES_LISTS" && LB_REPOSITORIES+=" trinity"
grep -wq -e virtualbox -e vbox <<<"$LB_PACKAGES $LB_PACKAGES_LISTS" && LB_REPOSITORIES+=" vbox"
grep -wq -e opera <<<"$LB_PACKAGES $LB_PACKAGES_LISTS" && LB_REPOSITORIES+=" opera"
grep -wq chrome <<<"$LB_PACKAGES $LB_PACKAGES_LISTS" && LB_REPOSITORIES+=" chrome"
lb config noauto --linux-packages "$LB_LINUX_PACKAGES" --linux-flavours "$LB_LINUX_FLAVOURS" --repositories "$LB_REPOSITORIES" -p "$LB_PACKAGES_LISTS"

# Make sure config-arguments don't get overwritten by auto-configuration
lb config noauto "${@}"

# Fetch kanotix-scripts if necessary
mkdir -p config/chroot_local-includes/usr/local/bin
grep -oe '^[^ #]*' scripts.urls | wget -i- -N -q -P config/chroot_local-includes/usr/local/bin
chmod 755 config/chroot_local-includes/usr/local/bin/*.sh
chmod 755 config/chroot_local-includes/usr/local/bin/*.bash

exit 1
